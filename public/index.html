<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<title>BrewSys :: Brewing Software</title>
		<meta name="description" content="">
		<meta name="viewport" content="width=device-width">

		<link rel="stylesheet" href="css/bootstrap.css">
		<style>
			body {
				padding-top: 60px;
				padding-bottom: 40px;
			}
		</style>


		<link rel="stylesheet" href="css/bootstrap-responsive.min.css">
		<link rel="stylesheet" href="css/custom-theme/jquery-ui-1.8.16.custom.css">
		
		<link rel="stylesheet" href="css/bml.css">

		
		<link rel="stylesheet" href="js/vendor/codemirror/lib/codemirror.css">
		<link rel="stylesheet" href="js/vendor/codemirror/lib/util/simple-hint.css">
		<link rel="stylesheet" href="css/main.css">

	   
   
   

		<script src="js/vendor/modernizr-2.6.1-respond-1.1.0.min.js"></script>
	</head>
	<body>
		<!--[if lt IE 7]>
			<p class="chromeframe">You are using an outdated browser. <a href="http://browsehappy.com/">Upgrade your browser today</a> or <a href="http://www.google.com/chromeframe/?redirect=true">install Google Chrome Frame</a> to better experience this site.</p>
		<![endif]-->

		<!-- This code is taken from http://twitter.github.com/bootstrap/examples/hero.html -->

		<div class="navbar navbar-inverse navbar-fixed-top">
			<div class="navbar-inner">
				<div class="container">
					<a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
					</a>
					<a class="brand" href="#">BrewSys</a>
					<!--
					<div class="nav-collapse collapse">
						<ul class="nav">
							<li class="active"><a href="#">Home</a></li>
							<li><a href="#about">About</a></li>
							<li><a href="#contact">Contact</a></li>
						</ul>
					</div>
				-->
				</div>
			</div>
		</div>

		<div class="container">

			<div class="row">
				<div class="recipe-editor span6">
					<div class="section">
						<textarea id="code" name="code">
--INFO-------------------------------------
style: 10A 2008 American Pale Ale
brewers: 
size: 5 gallons

--GRAIN-------------------------------------
9 lbs American 2 row [1.8L 37PPG]
1 lbs Crystal 60 Malt [60L 34PPG]

--HOPS--------------------------------------
40 min 1 oz Centennial [10%]
10 min 1/2 oz Cascade (U.S.) [5%]
5 min 1/2 oz Cascade (U.S.) [5%]

--YEAST-------------------------------------
1pkg Safeale US-05 [73%]

--NOTES-------------------------------------
Yummy!
						</textarea>
					</div>
				</div>
				<div class="beer-results span6"><div class="section content"></div></div>
			</div>


			<!-- Example row of columns -->
			<div class="row" style="margin-top:2em;">
				<div class="span4">
					<h4>Beer Markup</h4>
					<p>
						Beer Markup Language (BML).
						A beer recipe syntax that is easy to write and read by humans yet has enough structure to be read by brewing software.
					</p>
					<p><a class="btn" href="https://github.com/frodare/beer-markup">View details &raquo;</a></p>
				</div>
				<div class="span4">
					<h4>Beerd Brewing</h4>
					<p>Beerd Brewing is a group of homebrewers mostly based in North Florida. Our mission is to make quality homebrewed beer and have fun educating people about brewing.</p>
					<p>Follow us on <a href='https://www.facebook.com/beerdbrews'>Facebook</a> to see the latest creations.</p> 
					<p><a class="btn" href="http://beerd.us">View details &raquo;</a></p>
				</div>
				<div class="span4">
					<h4>jsBrewCalc</h4>
					<p>JavaScript library of brewing calculations</p>
					<p><a class="btn" href="https://github.com/frodare/jsBrewCalc">View details &raquo;</a></p>
			   </div>
			</div>

			<hr>

			<footer>
				<p>&copy; Charles Howard 2012</p>
			</footer>

		</div> <!-- /container -->

		<script src="js/vendor/jquery-1.8.1.min.js"></script>
		<script src="js/vendor/jquery.tmpl.min.js"></script>
		<script src="js/vendor/jquery-ui-1.8.16.custom.min.js"></script>
		<script src="js/vendor/bootstrap.min.js"></script>


		<script src="js/vendor/codemirror/lib/codemirror.js"></script>
		<script src="js/vendor/codemirror/lib/util/simple-hint.js"></script>

		<script src="js/tables.js"></script>

		<script src="js/brewcalc.js"></script>
		<script src="js/brewcalc-gravity.js"></script>
		<script src="js/brewcalc-units.js"></script>
		
		<script src="js/main.js"></script>
		<script src="js/bml.js"></script>

		<script id="results-tmpl" type="text/x-jquery-tmpl">
			<div class="results-wrapper">
				<div class="summary">
					<div class="glass" style="background-color:${disp.srm.color};">
						<div class="glass-overlay"></div>
					</div>
					<div class="totals">
						<div>Grain: <b>${disp.glbs}</b> lbs</div>
						<div>Hops: <b>${disp.hoz}</b> oz</div>
						<div>12oz: <b>${disp.cal12oz}</b> cal</div>
					</div>
				</div>
				
				<div class="param ${disp.og.style}">
					<span class="label">OG</span>
					<span class="est">${disp.og.est}</span>
					<span class="guide-block">
						<div class="guide">${disp.og.max}</div>
						<div class="guide">${disp.og.min}</div>
					</span>
					<span class="conversion">XX brix</span>
				</div>
				<div class="param ${disp.fg.style}">
					<span class="label">FG</span>
					<span class="est">${disp.fg.est}</span>
					<span class="guide-block">
						<div class="guide">${disp.fg.max}</div>
						<div class="guide">${disp.fg.min}</div>
					</span>
					<span class="conversion">XX brix</span>
				</div>
				<div class="param ${disp.ibu.style}">
					<span class="label">IBU</span>
					<span class="est">${disp.ibu.est}</span>
					<span class="guide-block">
						<div class="guide">${disp.ibu.max}</div>
						<div class="guide">${disp.ibu.min}</div>
					</span>
				</div>
				<div class="param ${disp.srm.style}">
					<span class="label">SRM</span>
					<span class="est">${disp.srm.est}</span>
					<span class="guide-block">
						<div class="guide">${disp.srm.max}</div>
						<div class="guide">${disp.srm.min}</div>
					</span>
				</div>
				<BR>
				<div>
					<span class="label">PB OG</span>
					<span class="value"></span>
				</div>
				<div>
					<span class="label">ATT</span>
					<span class="value"></span>
				</div>
				<div>
					<span class="label">BU:GU</span>
					<span class="value">
						${disp.buog.est} 
						<span class="guide">(${disp.buog.avg} average)</span>
					</span>
				</div>
				<div>
					<span class="label">ABV</span>
					<span class="value">${disp.abv}</span>
				</div>
				<BR>
				

				
			</div>
		</script>

		<script>
			var display = $('.beer-results .content');
			$('#results-tmpl').template('results');
			
			/*
			$('#bml').bmlParser({
				update: function (ev, recipe) {
					var stats = BREWCALC.compute(recipe);
					
					display.html($.tmpl('results', {
						stats: stats,
						color: BREWCALC.units.convert('SRM', 'HTML_RGB', stats.srm) 
					}));

				}
			});*/
	


			CodeMirror.commands.autocomplete = function(e) {
				CodeMirror.simpleHint(e, CodeMirror.bmlHint);
			}


			var autoPatterns = {
				'grain' : /^[^\[]+$/,
				'hops' : /^[^\[]+$/,
				'info' : /./
			}


			function read(namespace, path) {
				var i, a = path.split('.');
				for (i = 0; i < a.length; i += 1) {
					var key = a[i];
					if (key.match(/^[0-9]{1,3}$/)) {
						key = parseInt(key, 10);
					}
					if (key === 0 && !$.isArray(namespace)) {
						continue;
					}
					if (typeof namespace === "undefined") {
						return undefined;
					}
					namespace = namespace[key];
					if (i === a.length - 1 || typeof namespace === "undefined") {
						return namespace;
					}
				}
			};

			function formatSG(f) {
				if(!f){
					return;
				}
				if(typeof(f) === 'number'){
					return f.toFixed(3);
				}
				return f;
			}

			var editor;

			function parse() {
				var val = editor.getValue();
				var recipe = BML.parse(val);


				var stats = BREWCALC.compute(recipe); 



				var d = {
					srm: {
						style: 'nominal',
						est: stats.srm,
						min: read(recipe, 'info.style.srm.min'),
						max: read(recipe, 'info.style.srm.max'),
						color: BREWCALC.units.convert('SRM', 'HTML_RGB', stats.srm)
					},
					og: {
						style: 'nominal',
						est: formatSG(stats.og),
						min: formatSG(read(recipe, 'info.style.og.min')),
						max: formatSG(read(recipe, 'info.style.og.max'))
					},
					fg: {
						style: 'nominal',
						est: formatSG(stats.fg),
						min: formatSG(read(recipe, 'info.style.fg.min')),
						max: formatSG(read(recipe, 'info.style.fg.max'))
					},
					ibu: {
						style: 'nominal',
						est: stats.ibu,
						min: read(recipe, 'info.style.ibu.min'),
						max: read(recipe, 'info.style.ibu.max')
					},
					buog: {
						style: 'nominal',
						est: stats.buog,
						avg: read(recipe, 'info.style.bugu')
					},
					abv: stats.abv,
					cal12oz: stats.cal12oz,
					glbs: stats.glbs,
					hoz: stats.hoz
				};
				

				function check(attr) {
					if(attr.min && attr.max){
						if(attr.est > attr.max || attr.est < attr.min){
							attr.style = 'warn';
						}
					}
				}

				check(d.srm);
				check(d.og);
				check(d.fg);
				check(d.ibu);


				display.html($.tmpl('results', {
					disp: d
				}));
			}

			editor = CodeMirror.fromTextArea($('.recipe-editor textarea')[0], {
				mode: 'bml',
				lineNumbers: false,
				matchBrackets: true,
				theme: "default",
				onChange : function (cm, d) {
					/* d  {from, to, text, next} */
					var cursor = cm.getCursor()
					var section = cm.getStateAfter(cursor.line).section;
					var line = cm.getLine(cursor.line);

					/*
					 * determine wether to auto fire or not
					 */
					if (autoPatterns[section]) {
						if(line && line.match(autoPatterns[section])){
							CodeMirror.simpleHint(cm, CodeMirror.bmlHint);
						}
					}

				   
					parse();
				},

				extraKeys: {"Ctrl-Space": "autocomplete"}
			});
			parse();

		</script>

	</body>
</html>
